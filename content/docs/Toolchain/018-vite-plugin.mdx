---
title: æ€ä¹ˆç¼–å†™ä¸€ä¸ªè‡ªå·±çš„ Vite æ’ä»¶ï¼Ÿ
---

ç¼–å†™ä¸€ä¸ªè‡ªå·±çš„ Vite æ’ä»¶ï¼ˆVite Pluginï¼‰å…¶å®å¹¶ä¸å¤æ‚ï¼ŒVite æ’ä»¶æ˜¯åŸºäº **Rollup æ’ä»¶æœºåˆ¶**æ‰©å±•çš„ï¼Œä½†åˆåŠ å…¥äº† Vite ç‰¹æœ‰çš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

* ä¿®æ”¹æºç ï¼ˆä»£ç è½¬æ¢ã€æ³¨å…¥å˜é‡ç­‰ï¼‰
* è½¬æ¢æ–‡ä»¶ç±»å‹ï¼ˆå¦‚ Markdown è½¬ Vueï¼‰
* åšå¼€å‘æœåŠ¡ä¸­é—´ä»¶ï¼ˆå¦‚ mockï¼‰
* æ§åˆ¶æ„å»ºæµç¨‹

ä¸‹é¢è¯¦ç»†è®²è®²ç¼–å†™ä¸€ä¸ª Vite æ’ä»¶çš„ **å®Œæ•´æµç¨‹**ã€‚

---

## âœ… 1. åŸºæœ¬ç»“æ„

ä¸€ä¸ªæœ€ç®€å•çš„ Vite æ’ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰ `name` å±æ€§çš„å¯¹è±¡ï¼š

```js
// vite-plugin-example.js
export default function myPlugin(options) {
  return {
    name: 'vite-plugin-example', // æ’ä»¶å
    enforce: 'pre', // å¯é€‰ï¼š'pre' | 'post'ï¼Œæ§åˆ¶æ’ä»¶æ‰§è¡Œé¡ºåº
    transform(code, id) {
      // å¤„ç†æ¯ä¸ªæ¨¡å—ä»£ç 
      if (id.endsWith('.js')) {
        // ä¿®æ”¹ä»£ç é€»è¾‘
        return code.replace(/console\.log\(/g, 'console.info(');
      }
    },
  };
}
```

ç„¶ååœ¨ `vite.config.js` ä¸­ä½¿ç”¨ï¼š

```js
import myPlugin from './vite-plugin-example.js';

export default {
  plugins: [myPlugin()],
};
```

---

## âœ… 2. æ’ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆVite + Rollupï¼‰

Vite æ’ä»¶æœ¬è´¨ä¸Šæ˜¯ [Rollup æ’ä»¶](https://rollupjs.org/plugin-development/) + Vite æ‰©å±•ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„é’©å­ï¼š

### ğŸ“¦ Rollup å…±äº«é’©å­ï¼ˆå¼€å‘ + æ„å»ºé˜¶æ®µéƒ½èƒ½ç”¨ï¼‰ï¼š

| é’©å­                 | ä½œç”¨             |
| ------------------ | -------------- |
| `buildStart()`     | æ„å»ºå¼€å§‹æ—¶è°ƒç”¨        |
| `resolveId()`      | è‡ªå®šä¹‰æ¨¡å—è·¯å¾„è§£æ      |
| `load()`           | è‡ªå®šä¹‰æ–‡ä»¶åŠ è½½ï¼ˆè¿”å›ä»£ç ï¼‰  |
| `transform()`      | è½¬æ¢æ¨¡å—å†…å®¹ï¼ˆå¦‚æ›¿æ¢ã€ç¼–è¯‘ï¼‰ |
| `generateBundle()` | æ„å»ºäº§ç‰©ç”Ÿæˆåè°ƒç”¨      |

### âš¡ï¸ Vite ç‹¬æœ‰é’©å­ï¼ˆä»…å¼€å‘æ¨¡å¼ç”Ÿæ•ˆï¼‰ï¼š

| é’©å­                     | ä½œç”¨                   |
| ---------------------- | -------------------- |
| `config()`             | é…ç½® Vite æœ¬èº«çš„è¡Œä¸º        |
| `configureServer()`    | æ³¨å†Œå¼€å‘æœåŠ¡å™¨ä¸­é—´ä»¶ï¼ˆmock æœåŠ¡ç­‰ï¼‰ |
| `handleHotUpdate()`    | çƒ­æ›´æ–°æ—¶å¤„ç†é€»è¾‘ï¼ˆå¦‚å®šåˆ¶ HMR è¡Œä¸ºï¼‰ |
| `transformIndexHtml()` | æ“ä½œ `index.html`      |

---

## âœ… 3. å®æˆ˜ç¤ºä¾‹ï¼šè‡ªåŠ¨æ³¨å…¥ç¯å¢ƒå˜é‡

æ¯”å¦‚ä½ æƒ³å†™ä¸€ä¸ªæ’ä»¶ï¼Œè‡ªåŠ¨æŠŠ `import.meta.env.MY_VERSION` æ›¿æ¢æˆ `process.env.npm_package_version`ï¼š

```js
export default function injectVersionPlugin() {
  return {
    name: 'vite-plugin-inject-version',
    transform(code, id) {
      if (id.endsWith('.js') || id.endsWith('.ts')) {
        return {
          code: code.replace(
            /import\.meta\.env\.MY_VERSION/g,
            JSON.stringify(process.env.npm_package_version)
          ),
          map: null, // ä¸æä¾› source map
        };
      }
    }
  };
}
```

---

## âœ… 4. å¼€å‘æœåŠ¡å™¨ä¸­é—´ä»¶ï¼ˆmock ç¤ºä¾‹ï¼‰

å¦‚æœä½ æƒ³æ‹¦æˆªè¯·æ±‚ï¼Œæ¯”å¦‚è¿”å› mock æ•°æ®ï¼š

```js
export default function mockServerPlugin() {
  return {
    name: 'vite-plugin-mock-server',
    configureServer(server) {
      server.middlewares.use((req, res, next) => {
        if (req.url === '/api/user') {
          res.setHeader('Content-Type', 'application/json');
          res.end(JSON.stringify({ name: 'Nebula', age: 25 }));
        } else {
          next();
        }
      });
    }
  };
}
```

---

## âœ… 5. æ”¯æŒçƒ­æ›´æ–°ï¼ˆHMRï¼‰

å¦‚æœä½ å†™çš„æ’ä»¶å¤„ç†æŸäº›æ–‡ä»¶ï¼ˆæ¯”å¦‚ markdownã€é…ç½®æ–‡ä»¶ç­‰ï¼‰ï¼Œä½ å¯ä»¥åœ¨çƒ­æ›´æ–°æ—¶å¤„ç†ï¼š

```js
export default function myHMRPlugin() {
  return {
    name: 'vite-plugin-hmr-demo',
    handleHotUpdate({ file, server }) {
      if (file.endsWith('.md')) {
        console.log(`Markdown file changed: ${file}`);
        server.ws.send({
          type: 'full-reload', // æˆ– custom
        });
      }
    }
  };
}
```

---

## âœ… 6. æ’ä»¶æ‰§è¡Œé¡ºåºè¯´æ˜

* `enforce: 'pre'`ï¼šæ¯”é»˜è®¤æ’ä»¶æ›´æ—©æ‰§è¡Œï¼Œå¸¸ç”¨äº transformï¼ˆå¦‚ JSX -> JSï¼‰
* `enforce: 'post'`ï¼šæ¯”é»˜è®¤æ’ä»¶æ›´æ™šæ‰§è¡Œï¼Œå¸¸ç”¨äºå¤„ç†è¾“å‡ºç»“æœ

æ’ä»¶é¡ºåºå¾ˆé‡è¦ï¼Œä¾‹å¦‚ï¼š

```js
plugins: [
  prePlugin(),  // enforce: 'pre'
  myPlugin(),   // é»˜è®¤
  postPlugin()  // enforce: 'post'
]
```

---

## âœ… 7. å‘å¸ƒæ’ä»¶

1. æ·»åŠ  `package.json`ï¼Œå­—æ®µåŒ…æ‹¬ï¼š

   * `name`ã€`main`ã€`keywords`ã€`vite-plugin` ç­‰
2. å¯ä»¥ç”¨ [vite-plugin-xxx](https://vitejs.dev/plugins/) å‘½åè§„èŒƒ
3. å‘å¸ƒåˆ° npmï¼š

   ```bash
   npm publish --access public
   ```

---

## ğŸ§  å°è´´å£«ï¼šè°ƒè¯•æ’ä»¶çš„æ–¹æ³•

* åœ¨æ’ä»¶ä¸­ä½¿ç”¨ `console.log` è°ƒè¯•ä¸åŒé’©å­ã€‚
* ä½¿ç”¨ `vite --debug` è¿è¡Œå¯ä»¥çœ‹åˆ°æ’ä»¶æ‰§è¡Œæ—¥å¿—ã€‚
* ä½ ä¹Ÿå¯ä»¥é…åˆ `vite-inspect` æ’ä»¶æŸ¥çœ‹æ’ä»¶æ‰§è¡Œé¡ºåºå’Œ transformã€‚

---

## âœ… æ€»ç»“

| åŠŸèƒ½             | ä½¿ç”¨çš„é’©å­                    |
| -------------- | ------------------------ |
| æ›¿æ¢æ¨¡å—ä»£ç          | `transform()`            |
| è‡ªå®šä¹‰æ–‡ä»¶æ”¯æŒï¼ˆå¦‚ .mdï¼‰ | `load()` + `resolveId()` |
| mock æ¥å£        | `configureServer()`      |
| æ³¨å…¥ index.html  | `transformIndexHtml()`   |
| çƒ­æ›´æ–°é€»è¾‘          | `handleHotUpdate()`      |

---
