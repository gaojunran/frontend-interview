---
title: 如何在 Koa 中实现请求的幂等性？
---

在 Koa 中实现请求幂等性，需要理解“幂等性”的概念、常见做法，以及在 Koa 中的具体实现方式。我来详细拆解讲讲。

---

## 1️⃣ 幂等性概念

**幂等性（Idempotency）**指同一个请求执行一次或多次，对系统状态的影响是一样的，结果不会因为重复请求而变化。

* **安全操作**（GET、HEAD）天然幂等，因为它们不改变资源。
* **非安全操作**（POST、PUT、DELETE）可能不是幂等，需要人为保证。

**场景举例**：

* 订单创建接口（POST）：

  * 如果用户重复提交订单，可能生成多个订单 → 不是幂等。
  * 需要通过幂等性保证重复请求不会生成多份订单。

---

## 2️⃣ 常用幂等性实现方式

### (1) 幂等 key（Idempotency Key）

客户端生成唯一 key（UUID 或时间戳+用户 ID），放在请求头或请求体：

```
POST /orders
Idempotency-Key: abc123
```

服务器端：

1. 判断 `Idempotency-Key` 是否已存在：

   * 如果存在 → 返回之前处理结果。
   * 如果不存在 → 处理请求并保存结果。
2. 保存 `Idempotency-Key` 与请求结果（可存 Redis 或数据库）。

### (2) 去重校验

* 在数据库层做唯一约束（如订单号、交易号唯一）。
* 即使重复请求，数据库约束保证只会插入一次。

### (3) 乐观锁 / 事务

* 对关键资源加锁或使用事务，避免重复修改导致数据异常。

---

## 3️⃣ Koa 中实现幂等性的步骤

假设我们使用 **Idempotency Key + Redis** 的方式：

### (1) 安装依赖

```bash
npm install koa koa-bodyparser ioredis
```

### (2) Koa 中间件实现幂等性

```js
const Koa = require('koa');
const bodyParser = require('koa-bodyparser');
const Redis = require('ioredis');

const app = new Koa();
const redis = new Redis(); // 默认 localhost:6379

// 幂等性中间件
async function idempotencyMiddleware(ctx, next) {
  const key = ctx.headers['idempotency-key'];
  if (!key) {
    ctx.status = 400;
    ctx.body = { error: 'Idempotency-Key header is required' };
    return;
  }

  // 检查 key 是否存在
  const cached = await redis.get(key);
  if (cached) {
    // 已处理，返回缓存结果
    ctx.body = JSON.parse(cached);
    return;
  }

  // 执行请求
  await next();

  // 保存结果到 Redis, 设置过期时间避免无限增长
  await redis.set(key, JSON.stringify(ctx.body), 'EX', 60 * 60); // 1小时
}

app.use(bodyParser());
app.use(idempotencyMiddleware);

// 示例接口：创建订单
app.use(async (ctx) => {
  if (ctx.path === '/orders' && ctx.method === 'POST') {
    const orderId = Math.floor(Math.random() * 1000000);
    ctx.body = { orderId, status: 'created' };
  }
});

app.listen(3000, () => console.log('Server running on port 3000'));
```

---

### 4️⃣ 中间件原理解析

1. **客户端唯一 key**：`Idempotency-Key` 保证每次请求可以被唯一标识。
2. **缓存处理结果**：

   * Redis 存储 key → 结果映射。
   * 再次请求直接返回结果，无需重复业务逻辑。
3. **过期策略**：

   * 避免 Redis 无限增长。
   * 一般设置几小时到几天，根据业务决定。

---

### 5️⃣ 注意事项

1. **接口设计**：

   * GET/PUT/DELETE 默认幂等，POST 需要特别处理。
2. **业务逻辑幂等**：

   * 幂等 key 是防止重复请求，但内部逻辑也要保证不会因重复操作破坏数据。
3. **幂等性 key 生成**：

   * 客户端生成稳定唯一 key，例如 UUID 或订单号 + 用户 ID。
4. **安全性**：

   * 避免 key 被伪造。
   * 可以对 key 做 HMAC 签名校验。

---

💡 **总结**：

在 Koa 中实现请求幂等性，核心是：

1. 识别重复请求（幂等 key）。
2. 缓存或记录请求结果。
3. 对重复请求直接返回缓存结果。
4. 配合数据库约束或事务保证业务层幂等。

---

如果你愿意，我可以帮你画一张 **Koa 幂等请求流程图**，更直观展示请求处理流程。

你希望我画吗？
