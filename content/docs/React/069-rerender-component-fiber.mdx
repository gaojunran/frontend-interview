---
title: React 是如何判断何时重新渲染组件的？
---

React 判断是否重新渲染组件，是由 **状态（state）或属性（props）的变化触发的更新机制** 决定的。而实现这个机制的底层核心就是 React 16 引入的 **Fiber 架构**。

下面我们详细讲解：

---

## 一、React 如何判断何时重新渲染组件？

### 1.1 触发重新渲染的条件

React 会在以下情况触发组件的重新渲染：

* 组件的 `props` 发生变化
* 调用 `useState`、`useReducer` 等 hooks 更新了 state
* `forceUpdate()` 被调用（类组件）
* context 中的数据变化
* 父组件重新渲染（如果没有做 memo 优化）

### 1.2 React 的判断流程

React 并不会“比较组件是否需要更新”，而是采取“**一旦有状态或 props 改变，就调和（reconcile）并渲染该组件及其子树**”。

你可以理解为：

1. 有状态变化或 props 变化 → 触发该组件“更新调度”
2. 进入“调和阶段” → 判断当前节点是否需要重新渲染
3. 最终执行“提交阶段” → 执行 DOM 操作或副作用

所以 React 是**乐观地**认为“可能需要更新”，再在 Fiber 树中判断是否真正更新（通过对比）。

---

## 二、什么是 React Fiber？

### 2.1 背景

在 React 16 之前，React 是“递归调用组件函数 + 同步渲染”。这带来两个问题：

* 大组件树阻塞浏览器主线程（卡顿）
* 无法中断渲染，无法实现异步优先级调度

> 为了解决这些问题，React 16 引入了 **Fiber 架构**。

### 2.2 Fiber 是什么？

Fiber 是 React 的 **重新实现的协调引擎（Reconciliation Engine）**，它是：

* 将更新任务拆成一个个可以中断的小单元
* 使用链表代替递归，支持可中断、可恢复的渲染过程
* 支持任务的优先级、延迟、异步渲染、时间切片等功能

你可以把 Fiber 理解为 React 内部使用的 **工作单元结构（工作线程）**。

---

## 三、Fiber 架构的工作流程

React 的渲染过程可以分为两个阶段：

| 阶段                     | 作用                  | 是否可中断  | 是否同步 |
| ---------------------- | ------------------- | ------ | ---- |
| **调和阶段（Render Phase）** | 生成新的 Fiber 树，找出变化部分 | ✅ 可中断  | 通常异步 |
| **提交阶段（Commit Phase）** | 将变化应用到 DOM 和副作用     | ❌ 不可中断 | 必须同步 |

### 3.1 Render Phase：构建 Fiber 树

* React 遇到状态更新后，会以当前 Fiber 树为基础，创建一个 **新的 Fiber 树**
* 这个构建过程是通过“**递归调度任务（DFS）**”实现的，但不是调用栈的递归，而是通过 Fiber 链表结构手动维护栈

每一个 Fiber 节点上包含以下信息：

* 类型（函数组件、DOM 节点等）
* key、props、state
* 指向父、子、兄弟节点的指针
* effectTag（标记此节点需执行的操作，如插入、删除、更新）

> 如果某一帧耗时超过了 5ms，React 会把工作中断，让浏览器先绘制，然后再继续构建 Fiber 树。

### 3.2 Commit Phase：提交更改

* 找出哪些节点需要更新 DOM
* 执行这些变更：更新 DOM、ref、执行副作用（useEffect、生命周期钩子）

> 这一阶段是不能被中断的，因为 DOM 操作必须保持一致性。

---

## 四、React 如何“优化更新”？

### 4.1 比较新旧 Fiber 节点（diff 算法）

* 同级节点通过 `key` 和 `type` 做 diff，判断是否可以复用
* 对于无法复用的节点，则卸载旧节点、创建新节点

### 4.2 React.memo、PureComponent 优化

* `React.memo` 和 `PureComponent` 会对 props 做浅比较，避免不必要的更新
* 你可以通过 `shouldComponentUpdate` 或 `React.memo((props) => ..., [deps])` 控制是否更新

### 4.3 useMemo / useCallback

* 避免在渲染期间创建新的对象或函数引用，从而降低不必要的子组件更新

---

## 五、总结

| 关键点          | 说明                                        |
| ------------ | ----------------------------------------- |
| 判断更新         | React 通过 props、state 变化自动调度组件更新           |
| Fiber        | 是 React 的底层协调机制，用于分割更新任务                  |
| Render Phase | 构建新的 Fiber 树，可中断，可异步                      |
| Commit Phase | 应用变更，不可中断，必须同步                            |
| 性能优化         | 依靠 Fiber 的任务调度 + memo、useMemo、key 等机制优化渲染 |

---

如果你想更深入理解 Fiber，我可以为你画一张 Fiber 节点结构图，或写一个简化的 React Fiber 示例，你要看吗？
