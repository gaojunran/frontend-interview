---
title: 如何在 Node.js 中使用 Redis 实现数据缓存？
---

好的！我给你详细讲讲如何在 **Node.js** 中使用 **Redis** 实现数据缓存。内容包含基础概念、安装配置、代码示例、缓存设计思路和优化建议。

---

## 一、Redis 缓存简介

* **Redis** 是一个开源的内存数据存储系统，支持多种数据结构，常用作数据库、缓存、消息队列。
* 在 Node.js 应用中用 Redis 作为缓存，可以把一些频繁读取但不常变动的数据存入 Redis，避免每次都查询数据库，提高响应速度和系统性能。
* 缓存的基本流程：

  1. 应用请求数据时，先去 Redis 查缓存。
  2. 如果缓存命中（有数据），直接返回缓存结果。
  3. 如果缓存未命中（无数据），查询数据库获取数据，然后把结果写入 Redis 缓存，方便下次读取。

---

## 二、准备工作：安装 Redis 和客户端

1. **安装 Redis 服务器**

   * 本地开发可参考 [Redis 官网](https://redis.io/docs/getting-started/installation/) 安装 Redis。
   * 生产环境可用托管服务（如 AWS ElastiCache、Azure Redis Cache）或自建 Redis 集群。

2. **安装 Node.js Redis 客户端**

   Node.js 现在官方推荐用 [`redis`](https://www.npmjs.com/package/redis) 包。

   ```bash
   npm install redis
   ```

---

## 三、基本使用示例

```js
import { createClient } from 'redis';

// 1. 创建 Redis 客户端
const redisClient = createClient({
  url: 'redis://localhost:6379'
});

redisClient.on('error', (err) => console.log('Redis Client Error', err));

await redisClient.connect();

// 2. 缓存数据：设置 key 和 value
await redisClient.set('myKey', 'myValue', {
  EX: 60, // 设置过期时间，单位秒，比如 60秒
});

// 3. 读取缓存数据
const cachedValue = await redisClient.get('myKey');
console.log('Cached Value:', cachedValue);

// 4. 关闭客户端（程序结束时）
await redisClient.disconnect();
```

---

## 四、结合业务逻辑缓存数据库查询示例

假设有一个函数 `getUserById`，先查询缓存，缓存没命中再查数据库：

```js
async function getUserById(id) {
  const cacheKey = `user:${id}`;

  // 1. 先查缓存
  const cachedData = await redisClient.get(cacheKey);
  if (cachedData) {
    console.log('从缓存读取');
    return JSON.parse(cachedData);
  }

  // 2. 缓存没命中，查询数据库（伪代码）
  const userData = await database.queryUserById(id);

  if (userData) {
    // 3. 查询到后存入缓存，设置过期时间 5 分钟
    await redisClient.set(cacheKey, JSON.stringify(userData), {
      EX: 300,
    });
  }

  return userData;
}
```

---

## 五、缓存设计要点和优化

1. **合理设置过期时间**

   * 避免缓存数据长时间不更新导致脏数据。
   * 热点数据可设置较长过期，冷门数据设置短一点。

2. **缓存击穿、缓存雪崩防范**

   * 缓存击穿：缓存失效时大量请求打到数据库。用互斥锁（分布式锁）避免同一时刻大量请求查数据库。
   * 缓存雪崩：大量缓存同时过期导致数据库压力。可以用不同过期时间随机抖动。

3. **缓存穿透防范**

   * 缓存穿透指查询大量不存在数据导致数据库压力大。
   * 对不存在的数据缓存空值（比如空字符串或特殊标记）且设置较短过期时间。

4. **使用哈希、列表等 Redis 数据结构**

   * 复杂数据可以使用 Redis 哈希（hash）、集合（set）、有序集合（zset）等更高效存储。

5. **序列化和压缩**

   * JSON 序列化是常用做法，也可用更高效序列化方案（比如 protobuf）。
   * 对大数据可考虑压缩后缓存。

6. **监控和统计**

   * 监控缓存命中率、延迟等，评估缓存效果。
   * 记录缓存失效日志，优化缓存策略。

---

## 六、完整示例代码（Express + Redis 缓存）

```js
import express from 'express';
import { createClient } from 'redis';

const app = express();
const redisClient = createClient({ url: 'redis://localhost:6379' });

redisClient.on('error', (err) => console.log('Redis Client Error', err));

await redisClient.connect();

app.get('/user/:id', async (req, res) => {
  const userId = req.params.id;
  const cacheKey = `user:${userId}`;

  try {
    // 读取缓存
    const cached = await redisClient.get(cacheKey);
    if (cached) {
      return res.json({ source: 'cache', data: JSON.parse(cached) });
    }

    // 模拟数据库查询
    const userData = await fakeDatabaseQuery(userId);

    if (userData) {
      // 写缓存
      await redisClient.set(cacheKey, JSON.stringify(userData), { EX: 300 });
    }

    res.json({ source: 'db', data: userData });
  } catch (err) {
    res.status(500).json({ error: 'Internal Server Error' });
  }
});

// 模拟数据库查询函数
async function fakeDatabaseQuery(id) {
  // 模拟异步查询
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve({ id, name: 'Alice', age: 30 });
    }, 200);
  });
}

app.listen(3000, () => console.log('Server running on port 3000'));
```

---

## 七、总结

* Node.js 连接 Redis 通过 `redis` 包，异步操作方便。
* 缓存设计重点是“先查缓存，没命中查数据库，再写缓存”。
* 设置合适的过期时间和防止缓存穿透、击穿是实践关键。
* 监控缓存效果不断调优。

如果你需要，我还可以帮你写更复杂的示例，比如分布式锁、缓存异步刷新等高级场景。要不要？
