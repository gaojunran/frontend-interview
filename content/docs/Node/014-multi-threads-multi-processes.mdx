---
title: å¦‚ä½•åœ¨ Node.js ä¸­å¤„ç†å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹æ“ä½œï¼Ÿ
---

åœ¨ Node.js ä¸­ï¼Œè™½ç„¶ä¸»çº¿ç¨‹æ˜¯å•çº¿ç¨‹çš„ï¼ˆåŸºäºäº‹ä»¶å¾ªç¯ï¼‰ï¼Œä½†å®ƒæä¾›äº†å¤šç§æ–¹å¼æ¥è¿›è¡Œå¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹å¤„ç†ï¼Œä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€æé«˜å¹¶å‘æ€§èƒ½ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„è®²è§£ï¼š

---

## ğŸ§  èƒŒæ™¯ï¼šNode.js å•çº¿ç¨‹æ¨¡å‹

* Node.js çš„ JavaScript æ‰§è¡Œæ˜¯**å•çº¿ç¨‹çš„**ï¼ˆåŸºäº V8 å¼•æ“å’Œäº‹ä»¶å¾ªç¯ï¼‰ã€‚
* ä½†å®ƒçš„åº•å±‚ I/O æ“ä½œï¼ˆå¦‚æ–‡ä»¶ã€ç½‘ç»œï¼‰æ˜¯**å¼‚æ­¥éé˜»å¡**çš„ï¼Œé çš„æ˜¯ libuv æä¾›çš„çº¿ç¨‹æ± ã€‚
* è¦çœŸæ­£åˆ©ç”¨å¤šæ ¸ CPUï¼ŒNode.js æä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°å¹¶è¡Œå¤„ç†ã€‚

---

## ğŸ§µ æ–¹æ³•ä¸€ï¼šWorker Threadsï¼ˆå¤šçº¿ç¨‹ï¼‰

> ä» Node.js v10.5 å¼€å§‹æ”¯æŒï¼Œé€‚ç”¨äº CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚å›¾åƒå¤„ç†ã€åŠ å¯†ç­‰ï¼‰ã€‚

### âœ… ç‰¹ç‚¹ï¼š

* çœŸæ­£çš„å¤šçº¿ç¨‹ï¼ˆæ¯ä¸ª Worker æ˜¯ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹ï¼‰
* ä¸ä¸»çº¿ç¨‹å…±äº«å†…å­˜ï¼ˆä½¿ç”¨ `SharedArrayBuffer`ï¼‰
* é€‚åˆ CPU å¯†é›†å‹å·¥ä½œï¼ˆä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ï¼‰

### ğŸ”§ ç¤ºä¾‹ï¼š

```js
// main.js
const { Worker } = require('worker_threads');

function runWorker(workerData) {
  return new Promise((resolve, reject) => {
    const worker = new Worker('./worker.js', { workerData });

    worker.on('message', resolve);
    worker.on('error', reject);
    worker.on('exit', code => {
      if (code !== 0)
        reject(new Error(`Worker stopped with exit code ${code}`));
    });
  });
}

runWorker({ num: 42 })
  .then(result => console.log('Result:', result))
  .catch(err => console.error(err));
```

```js
// worker.js
const { parentPort, workerData } = require('worker_threads');

// æ¨¡æ‹Ÿ CPU å¯†é›†è®¡ç®—
let result = workerData.num * 2;
parentPort.postMessage(result);
```

---

## ğŸ§© æ–¹æ³•äºŒï¼šChild Processï¼ˆå¤šè¿›ç¨‹ï¼‰

> å¯åŠ¨ä¸€ä¸ªæ–°çš„ Node.js è¿›ç¨‹ï¼Œä¸ä¸»è¿›ç¨‹é€šè¿‡ IPC é€šä¿¡ã€‚

### âœ… ç‰¹ç‚¹ï¼š

* æ¯ä¸ªå­è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ Node å®ä¾‹
* é€šä¿¡é  IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ç®¡é“
* é€‚åˆæ‰§è¡Œå¤–éƒ¨å‘½ä»¤ã€shell è„šæœ¬æˆ–éš”ç¦»ä»»åŠ¡

### ğŸ”§ ç¤ºä¾‹ï¼š

```js
// main.js
const { fork } = require('child_process');

const child = fork('child.js');

child.send({ msg: 'start', value: 10 });

child.on('message', (data) => {
  console.log('Received from child:', data);
});
```

```js
// child.js
process.on('message', (data) => {
  console.log('Child received:', data);
  process.send({ result: data.value * 2 });
});
```

---

## ğŸ§± æ–¹æ³•ä¸‰ï¼šCluster æ¨¡å—ï¼ˆå¤šè¿›ç¨‹ + è´Ÿè½½å‡è¡¡ï¼‰

> ç”¨äºåˆ›å»ºå¤šä¸ª Node.js å®ä¾‹ç›‘å¬åŒä¸€ä¸ªç«¯å£ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

### âœ… ç‰¹ç‚¹ï¼š

* å†…éƒ¨ä½¿ç”¨ child\_process.fork åˆ›å»ºå­è¿›ç¨‹
* é€‚åˆæ„å»º HTTP æœåŠ¡çš„å¤šæ ¸æ‰©å±•

### ğŸ”§ ç¤ºä¾‹ï¼š

```js
// cluster_app.js
const cluster = require('cluster');
const http = require('http');
const os = require('os');

const numCPUs = os.cpus().length;

if (cluster.isPrimary) {
  // ä¸»è¿›ç¨‹ï¼šåˆ†å‰ worker
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }
  cluster.on('exit', (worker, code, signal) => {
    console.log(`Worker ${worker.process.pid} died`);
  });
} else {
  // å­è¿›ç¨‹ï¼šå¯åŠ¨æœåŠ¡å™¨
  http.createServer((req, res) => {
    res.writeHead(200);
    res.end(`Handled by worker ${process.pid}`);
  }).listen(8000);

  console.log(`Worker ${process.pid} started`);
}
```

---

## ğŸ” å¯¹æ¯”æ€»ç»“

| æ–¹æ³•               | å¹¶è¡Œæ¨¡å‹ | é€‚ç”¨åœºæ™¯          | é€šä¿¡æ–¹å¼        | ç‰¹ç‚¹         |
| ---------------- | ---- | ------------- | ----------- | ---------- |
| `Worker Threads` | å¤šçº¿ç¨‹  | CPU å¯†é›†å‹ä»»åŠ¡     | å…±äº«å†…å­˜ / æ¶ˆæ¯   | æ›´è½»é‡ï¼Œçº¿ç¨‹é—´é€šä¿¡å¿« |
| `Child Process`  | å¤šè¿›ç¨‹  | éš”ç¦»ä»»åŠ¡ã€æ‰§è¡Œå‘½ä»¤     | IPC / stdio | æ›´ç‹¬ç«‹ï¼Œå¯åŠ¨å¼€é”€å¤§  |
| `Cluster`        | å¤šè¿›ç¨‹  | å¤šæ ¸æ‰©å±• HTTP æœåŠ¡ç­‰ | å†…ç½®è´Ÿè½½å‡è¡¡      | ç®€å•é«˜æ•ˆæ‰©å±•æœåŠ¡å™¨  |

---

## ğŸ›  æ¨èåœºæ™¯

* âœ… **CPU å¯†é›†å‹è®¡ç®—**ï¼šä½¿ç”¨ `Worker Threads`
* âœ… **å¤šæ ¸ HTTP æœåŠ¡**ï¼šä½¿ç”¨ `Cluster`
* âœ… **æ‰§è¡Œå¤–éƒ¨è„šæœ¬ã€å‘½ä»¤**ï¼šä½¿ç”¨ `Child Process`
* âœ… **å…±äº«å†…å­˜ä¼˜åŒ–æ€§èƒ½**ï¼šç»“åˆ `Worker Threads` å’Œ `SharedArrayBuffer`

---

å¦‚éœ€è¿›ä¸€æ­¥è®²è§£æŸç§æ–¹å¼çš„é«˜çº§ç”¨æ³•ï¼Œæˆ–ç»“åˆå®é™…é¡¹ç›®åšä¾‹å­ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼
