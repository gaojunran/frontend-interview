---
title: å¦‚ä½•ä½¿ç”¨ Node.js è·å–åˆ°å®¢æˆ·ç«¯è¿æ¥çš„çœŸå® IPï¼Ÿ
---

åœ¨ Node.js ä¸­è·å–å®¢æˆ·ç«¯è¿æ¥çš„çœŸå® IP æ˜¯å¼€å‘ Web æœåŠ¡æ—¶ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œæ¯”å¦‚ç”¨äºæ—¥å¿—ã€é™æµã€å®‰å…¨æ§åˆ¶ç­‰ã€‚ä¸‹é¢è¯¦ç»†è®²è®²ï¼š

---

## âœ… ä¸€ã€åŸºæœ¬æ–¹æ³•ï¼šä½¿ç”¨ `req.connection.remoteAddress`

åœ¨ä¸ä½¿ç”¨ä»»ä½•æ¡†æ¶ï¼ˆæ¯”å¦‚ Expressï¼‰çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡åŸç”Ÿ HTTP æ¨¡å—è·å– IPï¼š

```js
const http = require('http');

const server = http.createServer((req, res) => {
  const ip = req.connection.remoteAddress;
  res.end(`Your IP is ${ip}`);
});

server.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

**é—®é¢˜ï¼š**

* è¿™ä¸ªæ–¹å¼åœ¨æœ¬åœ°æµ‹è¯•æ—¶å¯èƒ½ä¼šè¿”å›ï¼š`::1`ï¼ˆIPv6 çš„ localhostï¼‰ï¼Œ
* åœ¨å®é™…éƒ¨ç½²åˆ° Nginxã€CDNã€ä»£ç†æœåŠ¡å™¨åï¼Œè¿™ä¸ª IP ä¼šæ˜¯**ä»£ç†çš„ IP**ï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯çš„çœŸå® IPã€‚

---

## âœ… äºŒã€åœ¨æœ‰ä»£ç†æœåŠ¡å™¨çš„æƒ…å†µä¸‹è·å–çœŸå® IPï¼ˆä½¿ç”¨ `X-Forwarded-For`ï¼‰

### ğŸ‘‰ ä»£ç†ï¼ˆå¦‚ Nginxã€Cloudflareï¼‰ä¼šåœ¨ HTTP Header ä¸­åŠ å…¥ä¸€ä¸ªå« `X-Forwarded-For` çš„å¤´éƒ¨ï¼š

```http
X-Forwarded-For: å®¢æˆ·ç«¯IP, ä¸­é—´ä»£ç†1, ä¸­é—´ä»£ç†2...
```

åœ¨ Node.js ä¸­ä½ å¯ä»¥è¿™æ ·è·å–ï¼š

```js
function getClientIp(req) {
  const xff = req.headers['x-forwarded-for'];
  if (xff) {
    return xff.split(',')[0].trim(); // ç¬¬ä¸€ä¸ª IP å°±æ˜¯çœŸå®å®¢æˆ·ç«¯ IP
  }
  return req.connection.remoteAddress;
}
```

å®Œæ•´ç¤ºä¾‹ï¼š

```js
const http = require('http');

const server = http.createServer((req, res) => {
  const ip = req.headers['x-forwarded-for']?.split(',')[0].trim()
            || req.connection.remoteAddress;
  res.end(`Your IP is ${ip}`);
});

server.listen(3000);
```

---

## âœ… ä¸‰ã€å¦‚æœä½¿ç”¨ Express æ¡†æ¶

Express å¯¹æ­¤æä¾›äº†æ›´å‹å¥½çš„æ”¯æŒï¼š

### 1. é»˜è®¤æ–¹å¼ï¼š

```js
app.get('/', (req, res) => {
  const ip = req.ip;
  res.send(`Your IP is ${ip}`);
});
```

ä½† Express é»˜è®¤ä¸ä¿¡ä»» `X-Forwarded-For`ï¼Œä½ éœ€è¦å¯ç”¨å®ƒï¼š

### 2. å¯ç”¨ä»£ç†ä¿¡ä»»ï¼š

```js
app.set('trust proxy', true);

app.get('/', (req, res) => {
  res.send(`Your IP is ${req.ip}`);
});
```

---

## âœ… å››ã€å¤„ç† IPv6ã€`::ffff:` ç­‰æƒ…å†µ

æœ‰æ—¶å€™ä½ æ‹¿åˆ°çš„æ˜¯åƒ `::ffff:192.168.1.1`ï¼Œå®ƒå…¶å®æ˜¯ IPv4 çš„æ˜ å°„åœ°å€ã€‚å¯ä»¥ç”¨æ­£åˆ™å¤„ç†ï¼š

```js
function normalizeIp(ip) {
  return ip?.replace(/^.*:/, ''); // å»é™¤ ::ffff:
}
```

---

## âœ… äº”ã€éƒ¨ç½²æ—¶ Nginx è®¾ç½®ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ åœ¨ Nginx ä»£ç†ä¹‹åè¿è¡Œ Node.jsï¼Œç¡®ä¿ä½ è®¾ç½®äº†ï¼š

```nginx
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

---

## âœ… å…­ã€å®‰å…¨æ³¨æ„äº‹é¡¹

* `X-Forwarded-For` å¯ä»¥è¢«å®¢æˆ·ç«¯ä¼ªé€ ï¼Œä¸è¦ç›´æ¥ä¿¡ä»»å®ƒç”¨äºå®‰å…¨æ•æ„Ÿçš„é€»è¾‘ï¼ˆå¦‚ç™½åå•éªŒè¯ï¼‰ã€‚
* å¦‚æœä½ ä¿¡ä»»çš„æ˜¯ Cloudflareã€Nginxï¼Œè¯·é…ç½® `trust proxy` ä¸”åªä¿¡ä»»å¯ä¿¡ä»£ç† IPã€‚

---

## âœ… ä¸ƒã€å°ç»“

| åœºæ™¯        | è·å–æ–¹å¼                             |
| --------- | -------------------------------- |
| æ— ä»£ç†       | `req.connection.remoteAddress`   |
| æœ‰ä»£ç†       | `req.headers['x-forwarded-for']` |
| Express ä¸­ | è®¾ç½® `trust proxy` åç”¨ `req.ip`     |
| Nginx ä»£ç†ä¸­ | ç¡®ä¿ Nginx è®¾ç½®äº†è½¬å‘ header            |

---

éœ€è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ªå…¼å®¹æ‰€æœ‰æƒ…å†µçš„ IP è·å–å‡½æ•°å—ï¼Ÿ
