---
title: 如何在 Node.js 中实现纳秒级别的高精度计时？
---

在 Node.js 中，如果你想实现**纳秒级别的高精度计时**（通常用于性能分析、基准测试等场景），可以使用 Node.js 内建模块 `process.hrtime()` 或 `performance.now()`（来自 `perf_hooks` 模块）。下面详细讲解它们的使用方式和差异。

---

## 一、`process.hrtime()`：高分辨率实时时间

### ✅ 特点

* 返回的是一个 **高分辨率的时间差**（相对于任意固定时间点），适合计算两个时间点之间的差异。
* 精度高达 **纳秒（ns）级别**。
* **不受系统时间更改的影响**（例如用户修改系统时钟）。

### 🧪 使用方式

```js
const start = process.hrtime();

// 模拟耗时操作
for (let i = 0; i < 1e6; i++) {}

const diff = process.hrtime(start); // 返回 [seconds, nanoseconds]
console.log(`耗时: ${diff[0]} 秒 ${diff[1]} 纳秒`);

// 可以转为毫秒
const durationInMs = diff[0] * 1000 + diff[1] / 1e6;
console.log(`耗时: ${durationInMs.toFixed(3)} 毫秒`);
```

### 🧠 注意事项

* 结果总是返回一个数组 `[seconds, nanoseconds]`。
* 因为是相对时间，适合计算「时间差」，**不适合获取当前时间戳**。

---

## 二、`perf_hooks.performance.now()`：高分辨率绝对时间戳

### ✅ 特点

* 来自标准模块 `perf_hooks`。
* 返回自程序启动以来的 **毫秒数**（带小数点，精度可达微秒甚至纳秒）。
* 更像浏览器中的 `performance.now()`。
* 精度比 `Date.now()` 高得多。

### 🧪 使用方式

```js
const { performance } = require('perf_hooks');

const start = performance.now();

for (let i = 0; i < 1e6; i++) {}

const end = performance.now();
console.log(`耗时: ${(end - start).toFixed(3)} 毫秒`);
```

### 🧠 注意事项

* 返回的是以 **毫秒为单位的浮点数**（可以精确到微秒级）。
* 更适合用来获取高精度时间戳。

---

## 三、对比总结

| 特性        | `process.hrtime()` | `performance.now()` |
| --------- | ------------------ | ------------------- |
| 精度        | 纳秒（ns）             | 微秒\~纳秒（ms，小数）       |
| 返回值       | `[秒, 纳秒]`数组        | 毫秒（浮点数）             |
| 起始点       | 任意参考点（不可知）         | 程序启动时               |
| 适合用途      | 两个时间点间的差值          | 当前时间戳、高精度定时         |
| 是否受系统时间影响 | 否                  | 否                   |

---

## 四、封装一个纳秒计时函数（推荐方式）

你可以封装一个统一的高精度计时工具：

```js
function nsTimer() {
  const start = process.hrtime.bigint(); // Node 10+ 支持 BigInt
  return () => {
    const end = process.hrtime.bigint();
    const durationNs = end - start;
    return {
      ns: durationNs,
      ms: Number(durationNs) / 1e6,
    };
  };
}

// 使用
const stop = nsTimer();

for (let i = 0; i < 1e6; i++) {}

const { ns, ms } = stop();
console.log(`耗时: ${ns} 纳秒 (${ms.toFixed(3)} 毫秒)`);
```

---

## 五、补充：为什么不用 `Date.now()`？

* `Date.now()` 精度只到 **毫秒（ms）级别**。
* 容易受到系统时间变更影响。
* **不适合高精度性能测试或计时任务**。

---

## ✅ 总结

如果你需要在 Node.js 中实现纳秒级别的高精度计时：

* ✅ 推荐使用 `process.hrtime.bigint()` 获取真实纳秒差值；
* ✅ 或使用 `perf_hooks.performance.now()` 获取高精度的时间戳；
* ❌ 避免使用 `Date.now()` 进行微小时间差的测量。

如果你告诉我具体的应用场景（比如性能测试、打点日志、限速器、微秒调度），我可以进一步给你更合适的建议。
